---
title: "Everything carbon"
output: 
  bookdown::html_document2:
    base_format: rmarkdown::html_vignette
    toc: true
bibliography: references.bib
csl: nmi-csl-nmi-v1_11.csl
pkgdown:
  as_is: true
vignette: >
  %\VignetteIndexEntry{Everything carbon}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}

# required packages
require(data.table); require(BLN); require(ggplot2)

# set some default options for the html page
knitr::opts_chunk$set(echo = FALSE,
                      collapse = TRUE,
                      comment = "#>")
options(rmarkdown.html_vignette.check_title = FALSE)
setDTthreads(1)

```

```{r setup}

# load library for BLN
library(BLN)

# set default plotting theme
ggplot2::theme_set(theme_bw() +
                   theme(plot.title = element_text(size=10),
                         legend.text = element_text(size=10),
                         axis.text = element_text(size=10, colour = 'black'),
                         legend.position="inside",
                         legend.position.inside = c(0.7,0.2),
                         panel.grid.minor = element_blank(),
                         panel.grid.major = element_blank())
                  )
```

# Introduction
Well, not EVERYTHING carbon but anything you want to know about soil carbon in
the BLN package. This vignette delves into the functions underlying the evaluation
of climate soil ecosystem service functions.

BLN currently has four indicators which together determine the climate score
s_bln_esd_clim. These are:

* *i_clim_osb* using an organic matter balance approach, calculated by `bln_clim_cbalance()`,
* *i_clim_rothc* using RothC to simulate future soil carbon concentrations, calculated by `bln_clim_rothc()`,
* *i_clim_csat* comparing current soil carbon content with potential carbon content, calculated by `bln_clim_csat()`, and
* *i_clim_somers* calculated by `bln_clim_somers()` and is only applicable to peat soils.

This vignette first discusses each of these indicators and their function one
by one and closes with a look at how these three or four indicators are aggregated
to a single climate ecosystem service score.

# Organic matter balance
The organic matter balance method is a relatively straight forward method to estimate
whether, with a given management, the organic matter content of a soil is stable,
likely to decrease, or likely to increase. In short, one sums all inputs of
organic matter (crop residues, organic amendments, and green manures) and subtracts
the expected organic matter decomposition. This approach is used by the Dutch
tool [OS-balans](https://os-balans.nl/nl/).

BLN's OM balance differs somewhat from OS-balans but in essence uses the same approach.
The `bln_clim_cbalance` function checks the function input and wraps two functions
from the OBIC package. Of these `OBIC::calc_sombalance()` does the heavy lifting
as it calculates the balance. The organic matter fluxes are derived as follows:

* crop input: a fixed cultivation dependent value which can be found in 
`BLN::bln_crops[,.(B_LU_EOM, B_LU_EOM_RESIDUE)]` or `OBIC::crops.obic[,.(B_LU_EOM, B_LU_EOM_RESIDUE)]`
* compost input: depends on the M_COMPOST input argument, which is frequency of compost application (i.e. once every M_COMPOST years)
The actual OM input from compost is calculated only for arable crops as 15 * 218 / M_COMPOST
* manure input: for the contribution of manure to organic matter built up, it is assumed
that the available legal room to apply manure is filled with dairy slurry, see table \@ref(tab:manureInput) .
* green manure/catch crop input: if green manure is used, it is assumed  that
there is an organic matter input of 850 kg/ha. If the landuse's name contains
"mais" or "aardappel", a catch crop is mandatory and a green manure OM input of 850
kg/ha is used.
* organic matter decomposition: for fields where the soil organic matter content
is higher than 23%, the decomposition rate is 3145.513 kg/ha/year. For fields
with lower SOM concentrations, the decomposition rate is calculated as:
SOM * 0.1 * 0.3 * (-0.37 * log(SOM) + 1.8398) * (10 ^ 6) * 0.0487 * SOM ^ -0.453 * 0.57
see figure \@ref(fig:decompRate)


```{r manureInput, tab.cap="Organic matter input (kg/ha) given a landuse and soil P status."}
tab <- data.table::data.table(
  Landuse = c("arable", "arable", "arable", "arable", "grassland", "grassland", "grassland", "grassland"),
  `Soil P method` = c("P-water", "P-water", "P-water", "P-water", "P-Al", "P-Al", "P-Al", "P-Al"),
  `Soil P value` = c("<=25", "25:36", "36:55", ">55", "<=16", "16:27", "27:50", ">50"),
  `OM dose` = c(2584, 1615, 1292, 1077, 4000, 3333, 3000, 2667)
)

kableExtra::kable(tab)
```

```{r decompRate, fig.cap="Decomposition rate at a given soil organic matter content.", fig.align='left', fig.width=7}
dt <- data.table::data.table(
  SOM = seq(0.2, 25, 0.2)
)

dt[,`decomposition rate` := SOM * 0.1 * 0.3 * (-0.37 * log(SOM) + 1.8398) * (10 ^ 6) * 0.0487 * SOM ^ -0.453 * 0.57]
dt[SOM>23, `decomposition rate` := 3145.513]

ggplot(data = dt,
       mapping = aes(x = SOM,
                     y = `decomposition rate`)) +
  geom_line() +
  xlab("soil organic matter content, (%)") +
  ylab("decomposition rate, (kg/ha/year)")

```
# RothC
RothC is a dynamic soil carbon model with a long history of use. A complete 
description of the model is beyond the scope of this vignette, for an in-depth
description see @Coleman1996. RothC calculations in BLN are based on [RothC 26.3](https://www.verdeterreprod.fr/wp-content/uploads/2020/05/RothC_guide_WIN.pdf).

# Carbon saturation


# Carbon on peat soils (somers)


# Indicator aggregation


# Further reading

