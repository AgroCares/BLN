---
title: "Everything carbon"
output: 
  bookdown::html_document2:
    base_format: rmarkdown::html_vignette
bibliography: references.bib
csl: nmi-csl-nmi-v1_11.csl
pkgdown:
  as_is: true
vignette: >
  %\VignetteIndexEntry{Everything carbon}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}

# required packages
require(data.table); require(BLN); require(ggplot2)

# set some default options for the html page
knitr::opts_chunk$set(echo = FALSE,
                      collapse = TRUE,
                      comment = "#>")
options(rmarkdown.html_vignette.check_title = FALSE)
setDTthreads(1)

```

```{r setup}

# load library for BLN
library(BLN)

# set default plotting theme
ggplot2::theme_set(theme_bw() +
                   theme(plot.title = element_text(size=10),
                         legend.text = element_text(size=10),
                         axis.text = element_text(size=10, colour = 'black'),
                         legend.position="inside",
                         legend.position.inside = c(0.7,0.2),
                         panel.grid.minor = element_blank(),
                         panel.grid.major = element_blank())
                  )
```

# Everything carbon
## Introduction
Well, not EVERYTHING carbon but anything you want to know about soil carbon in
the BLN package. This vignette delves into the functions underlying the evaluation
of climate soil ecosystem service functions.

BLN currently has four indicators which together determine the climate score
s_bln_esd_clim. These are:

* *i_clim_osb* using an organic matter balance approach, calculated by `bln_clim_cbalance()`,
* *i_clim_rothc* using RothC to simulate future soil carbon concentrations, calculated by `bln_clim_rothc()`,
* *i_clim_csat* comparing current soil carbon content with potential carbon content, calculated by `bln_clim_csat()`, and
* *i_clim_somers* calculated by `bln_clim_somers()` and is only applicable to peat soils.

This vignette first discusses each of these indicators and their function one
by one and closes with a look at how these three or four indicators are aggregated
to a single climate ecosystem service score.

## Organic matter balance
The organic matter balance method is a relatively straight forward method to estimate
whether, with a given management, the organic matter content of a soil is stable,
likely to decrease, or likely to increase. In short, one sums all inputs of
organic matter (crop residues, organic amendments, and green manures) and subtracts
the expected organic matter decomposition. This approach is used by the Dutch
tool \link[OS-balans]{https://os-balans.nl/nl/}.

BLN's OM balance differs somewhat from OS-balans but in essence uses the same approach.
The `bln_clim_cbalance` function checks the function input and wraps two functions
from the OBIC package. Of these `OBIC::calc_sombalance()` does the heavy lifting
as it calculates the balance. The organic matter fluxes are derived as follows:

* crop input: a fixed cultivation dependent value which can be found in 
`BLN::bln_crops[,.(B_LU_EOM, B_LU_EOM_RESIDUE)]` or `OBIC::crops.obic[,.(B_LU_EOM, B_LU_EOM_RESIDUE)]`
* compost input: depends on the M_COMPOST input argument, which is frequency of compost application (i.e. once every M_COMPOST years)
The actual OM input from compost is calculated only for arable crops as 15 * 218 / M_COMPOST
* manure input: for the contribution of manure to organic matter built up, it is assumed
that the available legal room to apply manure is filled with dairy slurry, see table \@ref(tab:manureInput) .
* green manure/cover crop input:
* organic matter decomposition:

```{r manureInput, tab.cap="Organic matter input (kg/ha) given a landuse and soil P status."}
tab <- data.table::data.table(
  Landuse = c("arable", "arable", "arable", "arable", "grassland", "grassland", "grassland", "grassland"),
  `Soil P method` = c("P-water", "P-water", "P-water", "P-water", "P-Al", "P-Al", "P-Al", "P-Al"),
  `Soil P value` = c("<=25", "25:36", "36:55", ">55", "<=16", "16:27", "27:50", ">50"),
  `OM dose` = c(2584, 1615, 1292, 1077, 4000, 3333, 3000, 2667)
)

kableExtra::kable(tab)
```


